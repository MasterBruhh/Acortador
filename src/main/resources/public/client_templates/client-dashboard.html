<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cliente - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos para modal y overlay */
        .modal-custom {
            display: none;
            position: fixed;
            z-index: 1050;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1040;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container my-5">
    <h2 class="mb-4">Dashboard</h2>

    <!-- Formulario para crear URL: se elige endpoint según backend -->
    <div th:if="${backend}=='grpc'">
        <form th:action="@{/grpc-client/createUrl}" method="post" class="mb-5">
            <div class="mb-3">
                <label for="originalUrl" class="form-label">URL Original</label>
                <input type="text" class="form-control" id="originalUrl" name="originalUrl" placeholder="Ingresa la URL original" required>
            </div>
            <button type="submit" class="btn btn-success">Crear URL (gRPC)</button>
        </form>
    </div>
    <div th:if="${backend}!='grpc'">
        <form th:action="@{/client/createUrl}" method="post" class="mb-5">
            <div class="mb-3">
                <label for="originalUrl" class="form-label">URL Original</label>
                <input type="text" class="form-control" id="originalUrl" name="originalUrl" placeholder="Ingresa la URL original" required>
            </div>
            <button type="submit" class="btn btn-success">Crear URL (REST)</button>
        </form>
    </div>

    <h3 class="mb-3">Listado de URLs</h3>
    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th>Vista Previa</th>
                <th>URL Original</th>
                <th>URL Acortada</th>
                <th>Fecha de Creación</th>
                <th>Estadísticas</th>
            </tr>
            </thead>
            <tbody id="urlTableBody">
            <!-- Se generarán las filas mediante JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para mostrar QR y tabla de detalles con scroll -->
<div id="modalOverlay" class="modal-overlay"></div>
<div id="detailModal" class="modal-custom">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Detalles del Enlace</h5>
        <button type="button" class="btn-close" onclick="closeModal()"></button>
    </div>
    <div id="modalContent"></div>
</div>

<script th:inline="javascript">
    /*
       Se espera que desde el controlador se pasen tres variables:
       - urlsJson: JSON con el listado de URLs.
       - baseUrl: URL base a utilizar para formar la URL acortada (ej. "http://bruhurl.azurewebsites.net").
       - backend: que indica "grpc" o "rest".
    */
    const urlsData = /*[[${urlsJson}]]*/ '[]';
    const urls = JSON.parse(urlsData);
    const baseUrl = /*[[${baseUrl}]]*/ 'http://bruhurl.azurewebsites.net';
    const backend = /*[[${backend}]]*/ 'rest';

    const tbody = document.getElementById("urlTableBody");
    urls.forEach(url => {
        const tr = document.createElement("tr");

        // Columna Vista Previa
        const tdPreview = document.createElement("td");
        if (url.previewImage && url.previewImage.trim() !== "") {
            const img = document.createElement("img");
            img.src = "data:image/png;base64," + url.previewImage;
            img.alt = "Vista Previa";
            img.style.height = "60px";
            tdPreview.appendChild(img);
        } else {
            tdPreview.textContent = "Sin vista previa";
        }
        tr.appendChild(tdPreview);

        // Columna URL Original
        const tdOriginal = document.createElement("td");
        tdOriginal.textContent = url.originalUrl;
        tr.appendChild(tdOriginal);

        // Columna URL Acortada
        const tdShort = document.createElement("td");
        const fullShortUrl = (url.shortUrl.startsWith("http") || url.shortUrl.startsWith("/go/"))
            ? url.shortUrl
            : baseUrl + "/go/" + url.shortUrl;
        const spanLink = document.createElement("span");
        spanLink.textContent = fullShortUrl;
        spanLink.classList.add("text-primary", "text-decoration-underline", "pointer");
        spanLink.addEventListener("click", function(e) {
            e.preventDefault();
            navigator.clipboard.writeText(fullShortUrl)
                .then(() => console.log("URL copiada"))
                .catch(err => console.error("Error al copiar URL", err));
            window.open(fullShortUrl, "_blank");
            showModal(url.previewImage, fullShortUrl, url.createdAt, url.statistics);
        });
        tdShort.appendChild(spanLink);
        tr.appendChild(tdShort);

        // Columna Fecha de Creación
        const tdCreated = document.createElement("td");
        if (url.createdAt) {
            const fecha = new Date(url.createdAt);
            tdCreated.textContent = fecha.toLocaleString();
        } else {
            tdCreated.textContent = "No especificada";
        }
        tr.appendChild(tdCreated);

        // Columna Estadísticas
        const tdStats = document.createElement("td");
        const accessCount = url.statistics?.accessCount ?? 0;
        tdStats.innerHTML = "Accesos: " + accessCount + " ";
        const btnStats = document.createElement("button");
        btnStats.textContent = "Ver Detalles";
        btnStats.classList.add("btn", "btn-sm", "btn-primary", "ms-2");
        btnStats.addEventListener("click", function(e) {
            e.stopPropagation();
            showModal(url.previewImage, fullShortUrl, url.createdAt, url.statistics);
        });
        tdStats.appendChild(btnStats);
        tr.appendChild(tdStats);

        tbody.appendChild(tr);
    });

    function showModal(previewBase64, shortUrl, createdAt, statistics) {
        const modal = document.getElementById("detailModal");
        const overlay = document.getElementById("modalOverlay");
        const modalContent = document.getElementById("modalContent");
        modalContent.innerHTML = "";

        // Mostrar el código QR en la parte superior
        const qrImg = document.createElement("img");
        qrImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(shortUrl)}&size=150`;
        qrImg.alt = "Código QR";
        modalContent.appendChild(qrImg);

        // Mostrar la fecha de creación (si disponible)
        if (createdAt) {
            const pCreated = document.createElement("p");
            const fecha = new Date(createdAt).toLocaleString();
            pCreated.innerHTML = `<strong>Fecha de Creación:</strong> ${fecha}`;
            pCreated.classList.add("mt-3");
            modalContent.appendChild(pCreated);
        }

        // Construir la tabla con scroll para mostrar la lista de detalles (accessDetails)
        if (statistics && statistics.accessDetails && statistics.accessDetails.length > 0) {
            // Contenedor para la tabla con scroll
            const scrollContainer = document.createElement("div");
            scrollContainer.style.maxHeight = "300px";
            scrollContainer.style.overflowY = "auto";
            scrollContainer.classList.add("mt-3");

            // Crear la tabla
            const table = document.createElement("table");
            table.classList.add("table", "table-sm", "table-striped");

            // Cabecera de la tabla
            const thead = document.createElement("thead");
            const headRow = document.createElement("tr");
            const headers = ["Fecha/Hora", "IP", "Navegador", "Plataforma"];
            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            // Cuerpo de la tabla
            const tbodyTable = document.createElement("tbody");
            statistics.accessDetails.forEach(detail => {
                const tr = document.createElement("tr");
                const tdTime = document.createElement("td");
                tdTime.textContent = new Date(detail.timestamp).toLocaleString();
                const tdIp = document.createElement("td");
                tdIp.textContent = detail.ip;
                const tdBrowser = document.createElement("td");
                tdBrowser.textContent = detail.browser;
                const tdPlatform = document.createElement("td");
                tdPlatform.textContent = detail.platform;
                tr.appendChild(tdTime);
                tr.appendChild(tdIp);
                tr.appendChild(tdBrowser);
                tr.appendChild(tdPlatform);
                tbodyTable.appendChild(tr);
            });
            table.appendChild(tbodyTable);
            scrollContainer.appendChild(table);
            modalContent.appendChild(scrollContainer);
        } else {
            const noStats = document.createElement("p");
            noStats.textContent = "No hay detalles de acceso disponibles.";
            noStats.classList.add("mt-3");
            modalContent.appendChild(noStats);
        }

        overlay.style.display = "block";
        modal.style.display = "block";
    }

    function closeModal() {
        document.getElementById("detailModal").style.display = "none";
        document.getElementById("modalOverlay").style.display = "none";
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
